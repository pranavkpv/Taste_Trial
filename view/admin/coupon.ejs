<%- include('partials/admin') %>

<div class="mt-5 w-75" style="margin-left:15%;">
  <div class="container-fluid px-4 py-4">

    <!-- Header with title and Add button -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h3 class="mb-0">Coupon Management</h3>
      <button class="btn btn-success addItem" onclick="addItem()" data-bs-toggle="modal" data-bs-target="#addCouponModal">
        <i class="fas fa-plus me-1"></i> Add Item
      </button>
    </div>

    <!-- Search Bar -->
    <div class="row mb-3">
      <div class="col-md-6 col-sm-12">
        <div class="input-group">
          <span class="input-group-text bg-success text-light">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" id="searchInput" oninput="searchCoupon(this.value)" class="form-control"
            placeholder="Search by Couponcode..." value="<%= searchedCoupon %>">
        </div>
      </div>
    </div>

    <!-- Coupons Table -->
    <div class="table-responsive">
      <table class="table table-hover text-center align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>Sl No</th>
            <th>Coupon Code</th>
            <th>Discount %</th>
            <th>Expiry Date</th>
            <th style="width: 150px;">Action</th>
          </tr>
        </thead>
        <tbody>
          <% formattedCoupons.forEach((element,index) => { %>
          <tr>
            <td class="tableindex"><%= selectedIndex + index %></td>
            <td class="tabledata"><%= element.couponCode %></td>
            <td class="tabledata"><%= element.discount_per %></td>
            <td class="tabledata"><%= element.expiryDate %></td>
            <td>
              <a href="#" class="text-success me-3 cursor-pointer" data-bs-toggle="modal" data-bs-target="#editCouponModal"
                onclick="editFun('<%= element._id %>', '<%= element.couponCode %>', '<%= element.discount_per %>', '<%= element.expiryDate %>')" title="Edit">
                <i class="bi bi-pencil-square fs-5"></i>
              </a>
              <a href="#" class="text-danger cursor-pointer" data-bs-toggle="modal" data-bs-target="#DeleteCoupon"
                onclick="deleteFun('<%= element._id %>')" title="Delete">
                <i class="bi bi-trash3-fill fs-5"></i>
              </a>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Coupon pagination" class="d-flex justify-content-center mt-4">
      <ul class="pagination pagination-sm">
        <% for(let i =1; i <= totalPage; i++) { %>
          <li class="page-item <%= i === selectedPage ? 'active' : '' %>">
            <button class="page-link <%= i === selectedPage ? 'bg-success text-white' : '' %>" onclick="selectedPage('<%= i %>')"><%= i %></button>
          </li>
        <% } %>
      </ul>
    </nav>

  </div>
</div>

<!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered custom-modal-width">
    <div class="modal-content">
      <form action="/admin/addcoupon" method="post" onsubmit="return validateForm()">
        <div class="modal-body">
          <h2 class="mb-3">Add Coupon</h2>
          <div class="mb-3">
            <label for="couponCode" class="form-label">Enter Coupon Code</label>
            <input type="text" class="form-control" id="couponCode" placeholder="Enter code" name="couponCode" />
            <p class="text-danger d-none error-message" id="couponhidden">Please Enter coupon code!</p>
          </div>
          <div class="mb-3">
            <label for="discount" class="form-label">Enter Discount %</label>
            <input type="number" class="form-control" id="discount" min="0" placeholder="Enter discount" name="discount" value="0" />
            <p class="text-danger d-none error-message" id="discounthidden">Please Enter Discount %!</p>
          </div>
          <div class="mb-3">
            <label for="expiryDate" class="form-label">Select Expiry Date</label>
            <input type="date" class="form-control" id="expiryDate" name="expirydate" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered custom-modal-width">
    <div class="modal-content">
      <form action="/admin/editCoupon" method="post" onsubmit="return validateForm()">
        <div class="modal-body">
          <h2 class="mb-3">Edit Coupon</h2>
          <input type="hidden" id="editId" name="couponId" />
          <div class="mb-3">
            <label for="editcouponCode" class="form-label">Enter Coupon Code</label>
            <input type="text" class="form-control" id="editcouponCode" placeholder="Enter code" name="couponCode" />
            <p class="text-danger d-none error-message" id="couponhidden">Please Enter coupon code!</p>
          </div>
          <div class="mb-3">
            <label for="editdiscount" class="form-label">Enter Discount %</label>
            <input type="number" class="form-control" id="editdiscount" min="0" placeholder="Enter discount" name="discount" value="0" />
            <p class="text-danger d-none error-message" id="discounthidden">Please Enter Discount %!</p>
          </div>
          <div class="mb-3">
            <label for="editexpiryDate" class="form-label">Select Expiry Date</label>
            <input type="date" class="form-control" id="editexpiryDate" name="expirydate" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Coupon Modal -->
<div class="modal fade" id="DeleteCoupon" tabindex="-1" aria-labelledby="deleteCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered custom-modal-width">
    <div class="modal-content">
      <form action="/admin/deleteCoupon" method="post">
        <input type="hidden" id="deleteid" name="deleteid" />
        <div class="modal-body">
          <p>Do you want to delete the coupon?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  function editFun(id, couponCode, discount, expiryDate) {
    document.getElementById('editcouponCode').value = couponCode;
    document.getElementById('editId').value = id;
    document.getElementById('editdiscount').value = discount;
    const formattedDate = expiryDate.split('/').reverse().join('-');
    document.getElementById('editexpiryDate').value = formattedDate;
  }

  function deleteFun(id) {
    document.getElementById('deleteid').value = id;
  }

  let debounceTimer;
  function searchCoupon(value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const currentPage = 1;
      window.location.href = `/admin/coupon?coupon=${encodeURIComponent(value)}&page=${currentPage}`;
    }, 700);
  }

  function selectedPage(page) {
    const value = document.getElementById('searchInput').value;
    window.location.href = `/admin/coupon?coupon=${encodeURIComponent(value)}&page=${page}`;
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<% if (successmessage && successmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= successmessage %>",
    icon: "success",
    draggable: true
  });
</script>
<% } %>

<% if (existmessage && existmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= existmessage %>",
    icon: "info",
    confirmButtonText: "OK"
  }).then(() => {
    const addcoupon = document.getElementById('addCouponModal');
    if (addcoupon) {
      const modalInstance = new bootstrap.Modal(addcoupon);
      modalInstance.show();
    }
  });
</script>
<% } %>

<% if (editExistmessage && editExistmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= editExistmessage %>",
    icon: "info",
    draggable: true
  });
</script>
<% } %>
