<%- include('partials/admin') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

<div class="mt-5 w-75" style="margin-left:15%;">
  <div class="container-fluid px-4 py-4">

  <!-- Header with title and add button -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
    <h3 class="mb-0">Hotel Management</h3>
    <button class="btn btn-success" onclick="addItem()" data-bs-toggle="modal" data-bs-target="#addHotelModal">
      <i class="fas fa-plus me-1"></i> Add Item
    </button>
  </div>

  <!-- Search Bar -->
  <div class="row mb-3">
    <div class="col-md-6 col-sm-12">
      <div class="input-group">
        <span class="input-group-text bg-success text-white"><i class="fas fa-search"></i></span>
        <input type="text" id="searchInput" oninput="searchHotel(this.value)" class="form-control"
          placeholder="Search by Hotelname..." value="<%= searchedhotelname || '' %>" />
      </div>
    </div>
  </div>

  <!-- Hotels Table -->
  <div class="table-responsive">
    <table class="table table-hover text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Sl No</th>
          <th>Title</th>
          <th>Image</th>
          <th style="width: 150px;">Action</th>
        </tr>
      </thead>
      <tbody>
        <% hotels.forEach((element, index) => { %>
        <tr class="<%= element.is_blocked ? 'text-muted' : '' %>">
          <td class="tableindex"><%= startIndex + index %></td>
          <td class="tabledata"><%= element.hotelname %></td>
          <td><img src="<%= element.image %>" alt="Hotel Image" class="img-thumbnail"
              style="max-height:50px; max-width:100px; object-fit:cover;" /></td>
          <td>
            <a href="#" class="text-success me-2" data-bs-toggle="modal" data-bs-target="#editHotelModal"
              onclick="editfun('<%= element.hotelname %>', '<%= element.hoteladdress %>', '<%= element.contact_no %>', '<%= element.alternative_no %>', '<%= element.image %>', '<%= element._id %>', '<%= element.food_items %>')"
              title="Edit">
              <i class="bi bi-pencil-square fs-5"></i>
            </a>
            <a href="#" class="text-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteHotelModal"
              onclick="deletefun('<%= element._id %>')" title="Delete">
              <i class="bi bi-trash3-fill fs-5"></i>
            </a>
            <% if (element.is_blocked) { %>
            <a href="#" class="text-success" data-bs-toggle="modal" data-bs-target="#unblockHotelModal"
              onclick="unhidefun('<%= element._id %>')" title="Unblock">
              <i class="bi bi-eye fs-5"></i>
            </a>
            <% } else { %>
            <a href="#" class="text-secondary" data-bs-toggle="modal" data-bs-target="#blockHotelModal"
              onclick="hidefun('<%= element._id %>')" title="Block">
              <i class="bi bi-eye-slash fs-5"></i>
            </a>
            <% } %>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav aria-label="Category pagination" class="d-flex justify-content-center mt-4">
      <ul class="pagination pagination-sm">
        <% for (let i = 1; i <= page; i++) { %>
        <li class="page-item <%= i === selectedpage ? 'active' : '' %>">
          <button class="page-link <%= i === selectedpage ? 'bg-success' : '' %>"
            onclick="loadPage('<%= i %>')"><%= i %></button>
        </li>
        <% } %>
      </ul>
    </nav>

</div>
</div>

<!-- Add Hotel Modal -->
<div class="modal fade" id="addHotelModal" tabindex="-1" aria-labelledby="addHotelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content p-3">
      <form id="foodSelectionForm" action="/admin/addhotel" method="post" onsubmit="return validateForm()"
        enctype="multipart/form-data" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="addHotelModalLabel">Add Hotel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-wrap gap-4 justify-content-between">
          <div class="flex-grow-1 me-3" style="min-width: 300px;">
            <div class="mb-3">
              <label for="hotelname" class="form-label">Enter Hotel Name</label>
              <input type="text" id="hotelname" name="hotelname" class="form-control" placeholder="Enter Hotel Name"
                required />
              <div class="invalid-feedback">Please enter hotel name!</div>
            </div>
            <div class="mb-3">
              <label for="hoteladdress" class="form-label">Enter Hotel Address</label>
              <input type="text" id="hoteladdress" name="hoteladdress" class="form-control"
                placeholder="Enter Hotel Address" required />
              <div class="invalid-feedback">Please enter hotel address!</div>
            </div>
            <div class="mb-3">
              <label for="contactnumber" class="form-label">Enter Contact Number</label>
              <input type="text" id="contactnumber" name="contactnumber" class="form-control"
                placeholder="Enter Contact Number" required />
              <div class="invalid-feedback">Please enter contact number!</div>
            </div>
          </div>
          <div class="flex-grow-1" style="min-width: 300px;">
            <div class="mb-3">
              <label for="alternativenumber" class="form-label">Enter Alternative Number</label>
              <input type="text" id="alternativenumber" name="alternativenumber" class="form-control"
                placeholder="Enter Alternative Number" required />
              <div class="invalid-feedback">Please enter alternative number!</div>
            </div>
            <div class="mb-3">
              <label for="hotelImage" class="form-label">Upload Image</label>
              <input type="file" id="hotelImage" name="image" class="form-control" accept="image/*"
                onchange="previewImage(event)" required />
              <div class="invalid-feedback">Please upload an image!</div>
            </div>
            <div class="text-center mb-3">
              <img id="imagePreview" src="#" alt="Image Preview" class="img-thumbnail d-none"
                style="max-width: 200px;" />
            </div>
            <div class="mb-3">
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  Select Food Name
                </button>
                <ul class="dropdown-menu p-3" style="max-height:250px; overflow-y:auto;">
                  <li>
                    <div class="form-check">
                      <input class="form-check-input select-all" type="checkbox" id="selectAll"
                        onchange="selectAllCheckboxes(this)" />
                      <label class="form-check-label" for="selectAll">Select All</label>
                    </div>
                  </li>
                  <% foodss.forEach(element => { %>
                  <li>
                    <div class="form-check">
                      <input class="form-check-input option-checkbox food-checkbox" type="checkbox"
                        id="food_<%= element._id %>" name="foodname" value="<%= element._id %>" />
                      <label class="form-check-label" for="food_<%= element._id %>"><%= element.foodname %></label>
                    </div>
                  </li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <input type="hidden" name="selectedFoods" id="selectedFoods" />
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Hotel Modal -->
<div class="modal fade" id="editHotelModal" tabindex="-1" aria-labelledby="editHotelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content p-3">
      <form id="foodSelectionForm" action="/admin/edithotel" method="post" onsubmit="return editvalidateForm()"
        enctype="multipart/form-data" novalidate>
        <input type="hidden" id="editid" name="editid" />
        <div class="modal-header">
          <h5 class="modal-title" id="editHotelModalLabel">Edit Hotel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-wrap gap-4 justify-content-between">
          <div class="flex-grow-1 me-3" style="min-width: 300px;">
            <div class="mb-3">
              <label for="edithotelname" class="form-label">Enter Hotel Name</label>
              <input type="text" id="edithotelname" name="hotelname" class="form-control" placeholder="Enter Hotel Name"
                required />
              <div class="invalid-feedback">Please enter hotel name!</div>
            </div>
            <div class="mb-3">
              <label for="edithoteladdress" class="form-label">Enter Hotel Address</label>
              <input type="text" id="edithoteladdress" name="hoteladdress" class="form-control"
                placeholder="Enter Hotel Address" required />
              <div class="invalid-feedback">Please enter hotel address!</div>
            </div>
            <div class="mb-3">
              <label for="editcontactnumber" class="form-label">Enter Contact Number</label>
              <input type="text" id="editcontactnumber" name="contactnumber" class="form-control"
                placeholder="Enter Contact Number" required />
              <div class="invalid-feedback">Please enter contact number!</div>
            </div>
          </div>
          <div class="flex-grow-1" style="min-width: 300px;">
            <div class="mb-3">
              <label for="editalternativenumber" class="form-label">Enter Alternative Number</label>
              <input type="text" id="editalternativenumber" name="alternativenumber" class="form-control"
                placeholder="Enter Alternative Number" required />
              <div class="invalid-feedback">Please enter alternative number!</div>
            </div>
            <div class="mb-3">
              <label for="edithotelImage" class="form-label">Upload Image</label>
              <input type="file" id="edithotelImage" name="image" class="form-control" accept="image/*"
                onchange="previewImage(event)" />
            </div>
            <div class="text-center mb-3">
              <img id="editimagePreview" src="#" alt="Image Preview" class="img-thumbnail" style="max-width: 200px;" />
            </div>
            <div class="mb-3">
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  Select Food Name
                </button>
                <ul class="dropdown-menu p-3" style="max-height:250px; overflow-y:auto;">
                  <li>
                    <div class="form-check">
                      <input class="form-check-input select-all" type="checkbox" id="editselectAll"
                        onchange="selectAllCheckboxes(this)" />
                      <label class="form-check-label" for="editselectAll">Select All</label>
                    </div>
                  </li>
                  <% foodss.forEach(element => { %>
                  <li>
                    <div class="form-check">
                      <input class="form-check-input option-checkbox editfood-checkbox" type="checkbox"
                        id="editfood_<%= element._id %>" name="foodname" value="<%= element._id %>" />
                      <label class="form-check-label" for="editfood_<%= element._id %>"><%= element.foodname %></label>
                    </div>
                  </li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <input type="hidden" name="selectedFoods" id="editselectedFoods" />
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Block / Unblock / Delete modals (simplified layout) -->
<div class="modal fade" id="blockHotelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="/admin/hideHotel" method="post">
        <input type="hidden" id="hideid" name="hideid" />
        <div class="modal-body">
          <p>Do you want to hide the hotel?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="unblockHotelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="/admin/unHidehotel" method="post">
        <input type="hidden" id="unhideid" name="unhideid" />
        <div class="modal-body">
          <p>Do you want to unhide the hotel?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteHotelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="/admin/deleteHotel" method="post">
        <input type="hidden" id="deleteid" name="deleteid" />
        <div class="modal-body">
          <p>Do you want to delete the hotel?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  // Debounced search function
  let debounceTimer;
  function searchHotel(value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const currentPage = 1;
      window.location.href = `/admin/hotel?pagenumber=${ currentPage }&hotel=${ encodeURIComponent(value) }`;
    }, 700);
  }

  function loadPage(pageNumber) {
    const searchValue = document.getElementById('searchInput').value || '';
    window.location.href = `/admin/hotel?pagenumber=${ pageNumber }&hotel=${ encodeURIComponent(searchValue) }`;
  }

  // Preview image for add/edit
  function previewImage(event) {
    const input = event.target;
    const preview = document.getElementById('imagePreview');
    const editpreview = document.getElementById('editimagePreview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        if (preview) {
          preview.src = e.target.result;
          preview.classList.remove('d-none');
        }
        if (editpreview) {
          editpreview.src = e.target.result;
          editpreview.classList.remove('d-none');
        }
      };
      reader.readAsDataURL(input.files[0]);
    } else {
      if (preview) {
        preview.src = '#';
        preview.classList.add('d-none');
      }
      if (editpreview) {
        editpreview.src = '#';
        editpreview.classList.add('d-none');
      }
    }
  }

  // Modal setters
  function editfun(hotelname, hoteladdress, contactnumber, alternativenumber, image, id, fooditems) {
    document.getElementById('edithotelname').value = hotelname;
    document.getElementById('edithoteladdress').value = hoteladdress;
    document.getElementById('editcontactnumber').value = contactnumber;
    document.getElementById('editalternativenumber').value = alternativenumber;
    document.getElementById('editimagePreview').src = image;
    document.getElementById('editid').value = id;
    document.getElementById('editselectedFoods').value = fooditems;

    const foodItemsArray = Array.isArray(fooditems) ? fooditems : fooditems.split(',');
    const checkboxes = document.querySelectorAll('.editfood-checkbox');

    checkboxes.forEach(checkbox => {
      checkbox.checked = foodItemsArray.includes(checkbox.value);
    });
  }

  function deletefun(id) {
    document.getElementById('deleteid').value = id;
  }
  function hidefun(id) {
    document.getElementById('hideid').value = id;
  }
  function unhidefun(id) {
    document.getElementById('unhideid').value = id;
  }

  // Style blocked items
  document.querySelectorAll(".isblocked").forEach((statusElement, index) => {
    if (statusElement.textContent.trim() === "true") {
      document.querySelectorAll(".tabledata")[index].style.color = "#616362";
      document.querySelectorAll(".tableindex")[index].style.color = "#616362";
    }
  });

  // Select all checkboxes logic
  function selectAllCheckboxes(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.option-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
  }
  document.querySelectorAll('.option-checkbox').forEach((checkbox) => {
    checkbox.addEventListener('change', () => {
      const selectAll = document.getElementById('selectAll');
      const allChecked = [...document.querySelectorAll('.option-checkbox')].every(cb => cb.checked);
      selectAll.checked = allChecked;
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- SweetAlert notifications as per your server-side flags -->
<% if (existdatamessage && existdatamessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= existdatamessage %>",
    icon: "info",
    confirmButtonText: "OK",
  }).then(() => {
    const addhotelModal = document.getElementById('addHotelModal');
    if (addhotelModal) {
      const modalInstance = new bootstrap.Modal(addhotelModal);
      modalInstance.show();
    }
  });
</script>
<% } %>

<% if (saveddatamessage && saveddatamessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= saveddatamessage %>",
    icon: "success"
  });
</script>
<% } %>

<% if (errormessage && errormessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= errormessage %>",
    icon: "error"
  });
</script>
<% } %>

<% if (editexistmessage && editexistmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= editexistmessage %>",
    icon: "info"
  });
</script>
<% } %>