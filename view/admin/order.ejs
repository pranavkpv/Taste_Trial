<%- include('partials/admin') %>

<div class="mt-5 w-75" style="margin-left:15%;">
  <div class="container-fluid px-4 py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h3 class="mb-0">Order Management</h3>
    </div>

    <!-- Search and Status Filter -->
    <div class="row mb-3">
      <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
        <div class="input-group">
          <span class="input-group-text bg-success text-light">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" id="searchInput" oninput="searchInvoice(this.value)" class="form-control"
            placeholder="Search by Invoice Number..." value="">
        </div>
      </div>
      <div class="col-md-6 col-sm-12">
        <select id="status" class="form-select w-50" onchange="status()">
          <option value="">
            <% if (selectedStatus) { %><%= selectedStatus %><% } else { %>Select<% } %>
          </option>
          <option value="cancelled">Cancelled</option>
          <option value="delivered">Delivered</option>
          <option value="processing">Processing</option>
          <option value="packing">Packing</option>
          <option value="onTheWay">On The Way</option>
          <option value="returned">Returned</option>
          <option value="All">All</option>
        </select>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="table-responsive">
      <table class="table table-hover text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Invoice Number</th>
            <th>Client Name</th>
            <th>Product Name</th>
            <th>Rate</th>
            <th>Status</th>
            <th style="width: 100px;">View</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(element => { %>
          <tr>
            <td class="tabledata"><%= element.createdAtFormatted %></td>
            <td class="tabledata">INV-<%= element._id %></td>
            <td class="tabledata"><%= element.userDetails[0].firstname %></td>
            <td class="tabledata">
              <img src="<%= element.rateDetails[0].images[0] %>" alt="Product Image" class="img-thumbnail mb-1"
                style="height:50px; max-width:80px; object-fit: cover;" />
              <p class="mb-0"><%= element.foodDetails[0].foodname %></p>
            </td>
            <td class="tabledata">
              <% if (element.couponDetails.length > 0) { %>
                <%= (element.items.quantity * (element.items.rate + element.items.rate * element.items.gst_per / 100 + element.items.rate * element.items.packing_per / 100 - element.items.rate * element.items.offer_per / 100) - element.items.quantity * (element.items.rate + element.items.rate * element.items.gst_per / 100 + element.items.rate * element.items.packing_per / 100 - element.items.rate * element.items.offer_per / 100) * element.couponDetails[0].discount_per / 100).toFixed(2) %>
              <% } else { %>
                <%= (element.items.quantity * (element.items.rate + element.items.rate * element.items.gst_per / 100 + element.items.rate * element.items.packing_per / 100 - element.items.rate * element.items.offer_per / 100)).toFixed(2) %>
              <% } %>
            </td>
            <td class="tabledata">
              <div class="dropdown">
                <button class="btn dropdown-toggle 
                  <% if (element.items.status == "processing") { %>btn-warning
                  <% } else if (element.items.status == "packing") { %>btn-info
                  <% } else if (element.items.status == "onTheWay") { %>btn-secondary
                  <% } else if (element.items.status == "delivered") { %>btn-success
                  <% } else if (element.items.status == "cancelled") { %>btn-danger
                  <% } else { %>btn-danger
                  <% } %>" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <%= element.items.status %>
                </button>

                <% if (["cancelled", "delivered", "waiting for approval", "returned"].includes(element.items.status)) { %>
                <ul class="dropdown-menu d-none"></ul>
                <% } else { %>
                <ul class="dropdown-menu">
                  <% if (element.items.status == "processing") { %>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus('<%= element._id %>', '<%= element.items._id %>', 'packing')">Packing</a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus('<%= element._id %>', '<%= element.items._id %>', 'onTheWay')">On the Way</a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus('<%= element._id %>', '<%= element.items._id %>', 'delivered')">Delivered</a></li>
                  <% } else if (element.items.status == "packing") { %>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus('<%= element._id %>', '<%= element.items._id %>', 'onTheWay')">On the Way</a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus('<%= element._id %>', '<%= element.items._id %>', 'delivered')">Delivered</a></li>
                  <% } else if (element.items.status == "onTheWay") { %>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus('<%= element._id %>', '<%= element.items._id %>', 'delivered')">Delivered</a></li>
                  <% } %>
                </ul>
                <% } %>
              </div>
            </td>

            <td class="tabledata">
              <form action="/admin/orderDetails" method="GET" class="m-0">
                <input type="hidden" name="orderid" value="<%= element._id %>">
                <input type="hidden" name="rateid" value="<%= element.items.rate_id %>">
                <button type="submit" class="btn btn-success btn-sm">View</button>
              </form>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Order pagination" class="d-flex justify-content-center mt-4">
      <ul class="pagination pagination-sm">
        <% for (let i = 1; i <= page; i++) { %>
        <li class="page-item <%= i === selectedpage ? 'active' : '' %>">
          <button class="page-link <%= i === selectedpage ? 'bg-success text-white' : '' %>" onclick="loadPage('<%= i %>')"><%= i %></button>
        </li>
        <% } %>
      </ul>
    </nav>

  </div>
</div>

<%- include('partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-Zj0jHA9aU3xw8pZTGrt/5ZxnAq8X+ZdkrRek+6hsoTL9P1c2rNphthY9gLh7z81C" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function updateStatus(orderId, itemId, newStatus) {
    fetch('/admin/updateStatus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId, itemId, newStatus }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        Swal.fire({ text: "Status changed successfully", icon: "success", timer: 3000, showConfirmButton: false });
        setTimeout(() => location.reload(), 3000);
      } else {
        Swal.fire({ text: "Failed to update status. Please try again.", icon: "error", timer: 3000, showConfirmButton: false });
      }
    })
    .catch(error => console.error('Error:', error));
  }

  let debounceTimer;

  function searchInvoice(value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const currentPage = 1;
      const statusValue = document.getElementById('status').value || '';
      window.location.href = `/admin/order?pagenumber=${currentPage}&invoice=${encodeURIComponent(value)}&status=${statusValue}`;
    }, 700);
  }

  function loadPage(pageNumber) {
    const searchValue = document.getElementById('searchInput').value || '';
    const statusValue = document.getElementById('status').value || '';
    window.location.href = `/admin/order?pagenumber=${pageNumber}&invoice=${encodeURIComponent(searchValue)}&status=${statusValue}`;
  }

  function status() {
    const currentPage = 1;
    const searchValue = document.getElementById('searchInput').value || '';
    const statusValue = document.getElementById('status').value || '';
    window.location.href = `/admin/order?pagenumber=${currentPage}&invoice=${encodeURIComponent(searchValue)}&status=${statusValue}`;
  }
</script>
