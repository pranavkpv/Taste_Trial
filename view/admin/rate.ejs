<%- include('partials/admin') %>

<div class="mt-5 w-75" style="margin-left:15%;">
  <div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h3 class="mb-0">Rate Management</h3>
      <button class="btn btn-success" onclick="addItem()" data-bs-toggle="modal" data-bs-target="#addRateModal">
        <i class="fas fa-plus me-1"></i> Add Item
      </button>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-hover text-center align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>Sl No</th>
            <th>Hotelname</th>
            <th>Foodname</th>
            <th>VarientName</th>
            <th>Image</th>
            <th>Price</th>
            <th style="width: 150px;">Action</th>
          </tr>
        </thead>
        <tbody class="tableBody">
          <% ratecollections.forEach((element,index) => { %>
          <tr>
            <td class="tableindex"><%= startIndex+index %></td>
            <td class="tabledata"><%= element.hotelDetails[0].hotelname %></td>
            <td class="tabledata"><%= element.foodDetails[0].foodname %></td>
            <td class="tabledata"><%= element.varientDetails[0].varientname %></td>
            <td>
              <img src="<%= element.images[0] %>" alt="Image" class="img-thumbnail"
                style="height:50px; max-width:80px; object-fit: cover;">
            </td>
            <td class="tabledata"><%= element.rate %></td>
            <td>
              <a href="#" class="text-success me-2" data-bs-toggle="modal" data-bs-target="#editrateModal"
                onclick="editFun('<%= element.hotelDetails[0].hotelname %>', '<%= element.foodDetails[0].foodname %>', '<%= element.varientDetails[0].varientname %>', '<%= element.rate %>', '<%= element.gst_per %>', '<%= element.packing_per %>', '<%= element.delivery_time %>', '<%= element.images[0] %>', '<%= element.images[1] %>', '<%= element.images[2] %>', '<%= element._id %>', '<%= element.stock %>', '<%= element.files[0] %>', '<%= element.files[1] %>', '<%= element.files[2] %>')" title="Edit">
                <i class="bi bi-pencil-square fs-5"></i>
              </a>
              <a href="#" class="text-danger" data-bs-toggle="modal" data-bs-target="#deleterateModal"
                onclick="deletefun('<%= element._id %>')" title="Delete">
                <i class="bi bi-trash3-fill fs-5"></i>
              </a>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Rate pagination" class="d-flex justify-content-center mt-4">
      <ul class="pagination pagination-sm">
        <% for (let i = 1; i <= TotalPage; i++) { %>
          <li class="page-item <%= i === selectedPage ? 'active' : '' %>">
            <button class="page-link <%= i === selectedPage ? 'bg-success text-white' : '' %>" onclick="loadPage('<%= i %>')"><%= i %></button>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addRateModal" tabindex="-1" aria-labelledby="addRateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content p-3">
      <form action="/admin/addrate" id="addform" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
        <h3 class="mb-3">Add Rate</h3>
        <div class="row">
          <!-- Left Column -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="addhotel" class="form-label">Hotel Name</label>
              <select class="form-select" name="hotel_id" id="addhotel" placeholder="Enter Hotel name">
                <option value="">select</option>
                <% hotels.forEach(element => { %>
                <option value="<%= element._id %>"><%= element.hotelname %></option>
                <% }) %>
              </select>
              <p class="text-danger d-none" id="addhotelpop">Please Select Hotelname!</p>
            </div>

            <div class="mb-3">
              <label for="addfoodname" class="form-label">Food Name</label>
              <select class="form-select" name="food_id" id="addfoodname" placeholder="Enter Food name">
                <option value="">select</option>
                <% foodss.forEach(element => { %>
                <option value="<%= element._id %>"><%= element.foodname %></option>
                <% }) %>
              </select>
              <p class="text-danger d-none" id="addfoodnamepop">Please Select Foodname!</p>
            </div>

            <div class="mb-3">
              <label for="addvarientname" class="form-label">Varient Name</label>
              <select class="form-select" name="varient_id" id="addvarientname" placeholder="Enter Varient name">
                <option value="">select</option>
                <% varients.forEach(element => { %>
                <option value="<%= element._id %>"><%= element.varientname %></option>
                <% }) %>
              </select>
              <p class="text-danger d-none" id="addvarientnamepop">Please Select Varientname!</p>
            </div>

            <div class="mb-3">
              <label for="addRateinput" class="form-label">Rate</label>
              <input class="form-control" value="0" type="number" name="rate" id="addRateinput" placeholder="Enter Rate">
              <p class="text-danger d-none" id="addRateinputpop">Please Enter Rate!</p>
            </div>

            <div class="mb-3">
              <label for="addgstperinput" class="form-label">Gst %</label>
              <input class="form-control" value="0" type="number" name="gst_per" id="addgstperinput" placeholder="Enter Gst%">
              <p class="text-danger d-none" id="addgstperinputpop">Please Enter Gst%!</p>
            </div>

            <div class="mb-3">
              <label for="addgstamntinput" class="form-label">Gst Amount</label>
              <input class="form-control" value="0" type="number" name="Gstamnt" id="addgstamntinput" readonly>
            </div>

            <!-- Image 1 -->
            <div class="mb-3">
              <label for="firstImage" class="form-label">Upload First Image</label>
              <input class="form-control" type="file" id="firstImage" accept="image/*"
                onchange="initCropper(event, 'croppedImage1', 'cropContainer1','firstfilename')" name="images" />
              <input type="hidden" id="firstfilename" />

              <div id="cropContainer1" style="display: none; margin-top: 10px;">
                <img id="croppedImage1" style="max-width: 100%; height: auto;" alt="Cropped Image" />
                <button type="button" class="btn btn-success"
                  onclick="saveCroppedImage('croppedImage1', 'cropContainer1', 'previewImage1', 'previewContainer1', 'hiddenInput1')">Save</button>
              </div>

              <div id="previewContainer1" style="margin-top: 10px; display: none;">
                <img id="previewImage1" class="preview mt-3" style="max-width: 100%; height: auto;" alt="Preview Image" />
              </div>

              <input type="hidden" id="hiddenInput1" name="croppedImageData1" />
            </div>

            <!-- Image 2 -->
            <div class="mb-3">
              <label for="secondImage" class="form-label">Upload Second Image</label>
              <input class="form-control" type="file" id="secondImage" accept="image/*"
                onchange="initCropper(event, 'croppedImage2', 'cropContainer2','secondfilename')" name="images" />
              <input type="hidden" id="secondfilename" />

              <div id="cropContainer2" style="display: none; margin-top: 10px;">
                <img id="croppedImage2" style="max-width: 100%; height: auto;" alt="Cropped Image" />
                <button type="button" class="btn btn-success"
                  onclick="saveCroppedImage('croppedImage2', 'cropContainer2', 'previewImage2', 'previewContainer2', 'hiddenInput2')">Save</button>
              </div>

              <div id="previewContainer2" style="margin-top: 10px; display: none;">
                <img id="previewImage2" class="preview mt-3" style="max-width: 100%; height: auto;" alt="Preview Image" />
              </div>

              <input type="hidden" id="hiddenInput2" name="croppedImageData2" />
            </div>
          </div>

          <!-- Right Column -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="packingper" class="form-label">Packing Charge %</label>
              <input class="form-control" value="0" type="number" name="packing_per" id="packingper" placeholder="Enter packing charge %" />
              <p class="text-danger d-none" id="packingperpop">Please Enter Packing%!</p>
            </div>

            <div class="mb-3">
              <label for="packingcharge" class="form-label">Packing Charge</label>
              <input class="form-control" value="0" type="number" name="packingcharge" id="packingcharge" readonly />
            </div>

            <div class="mb-3">
              <label for="totalRate" class="form-label">Total Rate</label>
              <input class="form-control" value="0" type="number" name="totalRate" id="totalRate" readonly />
            </div>

            <div class="mb-3">
              <label for="deliverytime" class="form-label">Delivery Time (minutes)</label>
              <input class="form-control" value="0" type="text" name="delivery_time" id="deliverytime" placeholder="Enter delivery time" />
              <p class="text-danger d-none" id="deliverytimepop">Please Enter Delivery Time!</p>
            </div>

            <div class="mb-3">
              <label for="stock" class="form-label">Stock</label>
              <input class="form-control" value="0" type="number" name="stock" id="addstock" placeholder="Enter stock" />
              <p class="text-danger d-none" id="deliverytimepop">Please Enter valid stock</p>
            </div>

            <!-- Image 3 -->
            <div class="mb-3">
              <label for="thirdImage" class="form-label">Upload Third Image</label>
              <input class="form-control" type="file" id="thirdImage" accept="image/*"
                onchange="initCropper(event, 'croppedImage3', 'cropContainer3','thirdfilename')" name="images" />
              <input type="hidden" id="thirdfilename" />

              <div id="cropContainer3" style="display: none; margin-top: 10px;">
                <img id="croppedImage3" style="max-width: 100%; height: auto;" alt="Cropped Image" />
                <button type="button" class="btn btn-success"
                  onclick="saveCroppedImage('croppedImage3', 'cropContainer3', 'previewImage3', 'previewContainer3', 'hiddenInput3')">Save</button>
              </div>

              <div id="previewContainer3" style="margin-top: 10px; display: none;">
                <img id="previewImage3" class="preview mt-3" style="max-width: 100%; height: auto;" alt="Preview Image" />
              </div>

              <input type="hidden" id="hiddenInput3" name="croppedImageData3" />
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-center gap-3 mt-3">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Modal (similar structure as Add) -->
<div class="modal fade" id="editrateModal" tabindex="-1" aria-labelledby="editfoodModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content p-3">
      <form action="/admin/editRate" method="post" enctype="multipart/form-data" onsubmit="return editsubmit()">
        <h3 class="mb-3">Edit Rate</h3>
        <div class="row">
          <!-- Left Column -->
          <div class="col-md-6">
            <input type="hidden" id="editid" name="editid" />
            <!-- Hotel Name -->
            <div class="mb-3">
              <label for="edithotel" class="form-label">Hotel Name</label>
              <select id="edithotel" class="form-select" name="hotelname">
                <% hotels.forEach(element => { %>
                <option value="<%= element.hotelname %>"><%= element.hotelname %></option>
                <% }) %>
              </select>
            </div>

            <!-- Food Name -->
            <div class="mb-3">
              <label for="editfoodname" class="form-label">Food Name</label>
              <select id="editfoodname" class="form-select" name="foodname">
                <% foodss.forEach(element => { %>
                <option value="<%= element.foodname %>"><%= element.foodname %></option>
                <% }) %>
              </select>
            </div>

            <!-- Varient Name -->
            <div class="mb-3">
              <label for="editvarientname" class="form-label">Varient Name</label>
              <select id="editvarientname" class="form-select" name="varientname">
                <% varients.forEach(element => { %>
                <option value="<%= element.varientname %>"><%= element.varientname %></option>
                <% }) %>
              </select>
            </div>

            <!-- Rate Input -->
            <div class="mb-3">
              <label for="editRateinput" class="form-label">Rate</label>
              <input class="form-control" type="number" name="rate" id="editRateinput" placeholder="Enter Rate" />
              <p class="text-danger d-none" id="editratepop">Please Enter Rate!</p>
            </div>

            <!-- GST Percentage -->
            <div class="mb-3">
              <label for="editgstperinput" class="form-label">Gst %</label>
              <input class="form-control" type="number" name="gst_per" id="editgstperinput" placeholder="Enter Gst%" />
              <p class="text-danger d-none" id="editgstperinputpop">Please Enter Gst%!</p>
            </div>

            <!-- GST Amount -->
            <div class="mb-3">
              <label for="editgstamount" class="form-label">Gst Amount</label>
              <input class="form-control" type="number" name="Gstamnt" id="editgstamount" readonly />
            </div>

            <!-- First Image -->
            <div class="mb-3">
              <label for="editfirstImage" class="form-label">Upload First Image</label>
              <input class="form-control" type="file" id="editfirstImage" accept="image/*"
                onchange="initCropper(event, 'editcroppedImage1', 'editcropContainer1','editfirstfilename')" name="images" />
              <input type="hidden" id="editfirstfilename" name="editfirstfilename" />

              <div id="editcropContainer1" style="display: none; margin-top: 10px;">
                <img id="editcroppedImage1" style="max-width: 100%; height: auto;" alt="Cropped Image" />
                <button type="button" class="btn btn-success"
                  onclick="saveCroppedImage('editcroppedImage1', 'editcropContainer1', 'editpreviewImage1', 'editpreviewContainer1', 'edithiddenInput1')">Save</button>
              </div>

              <div id="editpreviewContainer1" style="margin-top: 10px;">
                <img id="editpreviewImage1" class="preview mt-3" style="max-width: 100%; height: auto;" alt="Preview Image" />
              </div>

              <input type="hidden" id="edithiddenInput1" name="editcroppedImageData1" />
            </div>

            <!-- Second Image -->
            <div class="mb-3">
              <label for="editsecondImage" class="form-label">Upload Second Image</label>
              <input class="form-control" type="file" id="editsecondImage" accept="image/*"
                onchange="initCropper(event, 'editcroppedImage2', 'editcropContainer2','editsecondfilename')" name="images" />
              <input type="hidden" id="editsecondfilename" name="editsecondfilename" />

              <div id="editcropContainer2" style="display: none; margin-top: 10px;">
                <img id="editcroppedImage2" style="max-width: 100%; height: auto;" alt="Cropped Image" />
                <button type="button" class="btn btn-success"
                  onclick="saveCroppedImage('editcroppedImage2', 'editcropContainer2', 'editpreviewImage2', 'editpreviewContainer2', 'edithiddenInput2')">Save</button>
              </div>

              <div id="editpreviewContainer2" style="margin-top: 10px;">
                <img id="editpreviewImage2" class="preview mt-3" style="max-width: 100%; height: auto;" alt="Preview Image" />
              </div>

              <input type="hidden" id="edithiddenInput2" name="editcroppedImageData2" />
            </div>
          </div>

          <!-- Right Column -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="editpackingper" class="form-label">Packing Charge %</label>
              <input class="form-control" type="number" name="packing_per" id="editpackingper" placeholder="Enter packing charge %" />
              <p class="text-danger d-none" id="editpackingperpop">Please Enter Packing Charge%!</p>
            </div>

            <div class="mb-3">
              <label for="editpackingamount" class="form-label">Packing Charge</label>
              <input class="form-control" type="number" name="packingcharge" id="editpackingamount" readonly />
            </div>

            <div class="mb-3">
              <label for="edittotalrate" class="form-label">Total Rate</label>
              <input class="form-control" type="number" name="totalRate" id="edittotalrate" readonly />
            </div>

            <div class="mb-3">
              <label for="editdeliverytime" class="form-label">Delivery Time (minutes)</label>
              <input class="form-control" type="text" name="delivery_time" id="editdeliverytime" placeholder="Enter delivery time" />
              <p class="text-danger d-none" id="editdeliverytimepop">Please Enter Delivery Time!</p>
            </div>

            <div class="mb-3">
              <label for="editstock" class="form-label">Stock</label>
              <input class="form-control" type="number" name="stock" id="editstock" placeholder="Enter stock number" />
              <p class="text-danger d-none" id="editstockpop">Please Enter valid stock number</p>
            </div>

            <!-- Third Image -->
            <div class="mb-3">
              <label for="editthirdImage" class="form-label">Upload Third Image</label>
              <input class="form-control" type="file" id="editthirdImage" accept="image/*"
                onchange="initCropper(event, 'editcroppedImage3', 'editcropContainer3','editthirdfilename')" name="images" />
              <input type="hidden" id="editthirdfilename" name="editthirdfilename" />

              <div id="editcropContainer3" style="display: none; margin-top: 10px;">
                <img id="editcroppedImage3" style="max-width: 100%; height: auto;" alt="Cropped Image" />
                <button type="button" class="btn btn-success"
                  onclick="saveCroppedImage('editcroppedImage3', 'editcropContainer3', 'editpreviewImage3', 'editpreviewContainer3', 'edithiddenInput3')">Save</button>
              </div>

              <div id="editpreviewContainer3" style="margin-top: 10px;">
                <img id="editpreviewImage3" class="preview mt-3" style="max-width: 100%; height: auto;" alt="Preview Image" />
              </div>

              <input type="hidden" id="edithiddenInput3" name="editcroppedImageData3" />
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-center gap-3 mt-3">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Block rate Modal -->
<div class="modal fade" id="blockrateModal" tabindex="-1" aria-labelledby="blockfoodModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered custom-modal-width">
    <div class="modal-content">
      <form action="/admin/hiderate" method="post">
        <input type="hidden" id="hideid" name="hideid" />
        <div class="modal-body">
          <p>Do you want to hide the rate?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Unblock rate Modal -->
<div class="modal fade" id="unblockrateModal" tabindex="-1" aria-labelledby="unblockHotelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered custom-modal-width">
    <div class="modal-content">
      <form action="/admin/unhiderate" method="post">
        <input type="hidden" id="unhideid" name="unhideid" />
        <div class="modal-body">
          <p>Do you want to unhide the rate?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete rate Modal -->
<div class="modal fade" id="deleterateModal" tabindex="-1" aria-labelledby="deleteHotelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered custom-modal-width">
    <div class="modal-content">
      <form action="/admin/deleterate" method="post">
        <input type="hidden" id="deleteid" name="deleteId" />
        <div class="modal-body">
          <p>Do you want to delete the rate?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
// Your existing JS validates, event handlers, cropper logic, and other scripts untouched
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<% if (successmessage && successmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= successmessage %>",
    icon: "success"
  });
</script>
<% } %>

<% if (errormessage && errormessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= errormessage %>",
    icon: "error"
  });
</script>
<% } %>

<% if (questionmessage && questionmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= questionmessage %>",
    icon: "question",
    confirmButtonText: "OK",
  }).then(() => {
    const addrateModal = document.getElementById('addRateModal');
    if (addrateModal) {
      const modalInstance = new bootstrap.Modal(addrateModal);
      modalInstance.show();
    }
  });
</script>
<% } %>

<% if (existmessage && existmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= existmessage %>",
    icon: "info",
    confirmButtonText: "OK",
  }).then(() => {
    const addrateModal = document.getElementById('addRateModal');
    if (addrateModal) {
      const modalInstance = new bootstrap.Modal(addrateModal);
      modalInstance.show();
    }
  });
</script>
<% } %>
