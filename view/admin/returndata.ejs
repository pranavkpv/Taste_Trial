<%- include('partials/admin') %>

<div class="mt-5 w-75" style="margin-left:15%;">
  <div class="container-fluid px-4 py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h3 class="mb-0">Return Order Management</h3>
    </div>

    <!-- Search Bar -->
    <div class="row mb-3">
      <div class="col-md-6 col-sm-12">
        <div class="input-group">
          <span class="input-group-text bg-success text-light">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" id="searchInput" oninput="searchInvoice(this.value)" class="form-control" placeholder="Search by Invoice Number..." value="">
        </div>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="table-responsive">
      <table class="table table-hover text-center align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Invoice Number</th>
            <th>Client Name</th>
            <th>Product Name</th>
            <th>Rate</th>
            <th>View</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(element => { %>
          <tr>
            <td class="tabledata"><%= element.createdAtFormatted %></td>
            <td class="tabledata">INV-<%= element._id %></td>
            <td class="tabledata"><%= element.userDetails[0].firstname %> <%= element.userDetails[0].lastname %></td>
            <td class="tabledata">
              <img src="<%= element.rateDetails[0].images[0] %>" alt="Product Image" class="img-thumbnail mb-1"
                style="height:50px; max-width:80px; object-fit: cover;">
              <p class="mb-0"><%= element.foodDetails[0].foodname %></p>
            </td>
            <td class="tabledata">
              <%= (element.items.quantity * (element.items.rate + element.items.rate * element.items.gst_per / 100 + element.items.rate * element.items.packing_per / 100 - element.items.rate * element.items.offer_per / 100)).toFixed(2) %>
            </td>
            <td class="tabledata">
              <form action="/admin/orderDetails" method="GET" class="m-0">
                <input type="hidden" name="orderid" value="<%= element._id %>">
                <input type="hidden" name="rateid" value="<%= element.items.rate_id %>">
                <input type="hidden" name="userid" value="<%= element.userDetails[0]._id %>">
                <button type="submit" class="btn btn-primary btn-sm">View</button>
              </form>
            </td>
            <td class="tabledata">
              <button class="btn btn-success btn-sm mb-2" 
                data-bs-toggle="modal" data-bs-target="#approveModal" 
                onclick="approve('<%= element._id %>', '<%= element.items.rate_id %>', '<%= element.items.quantity %>')">Approve
              </button><br />
              <button class="btn btn-danger btn-sm" style="width: 82px;" 
                data-bs-toggle="modal" data-bs-target="#rejectModal" 
                onclick="reject('<%= element._id %>', '<%= element.items.rate_id %>', '<%= element.items.quantity %>')">Reject
              </button>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Return orders pagination" class="d-flex justify-content-center mt-4">
      <ul class="pagination pagination-sm">
        <% for(let i=1; i <= page; i++) { %>
          <li class="page-item <%= i === selectedPage ? 'active' : '' %>">
            <button class="page-link <%=i === selectedPage ? 'bg-success text-white' : '' %>" onclick="loadPage('<%= i %>')">
              <%= i %>
            </button>
          </li>
        <% } %>
      </ul>
    </nav>

  </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approveModalLabel">Are You Sure?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/admin/approveReturn" method="post">
        <div class="modal-body">
          <p>Do you want to approve this return?</p>
        </div>
        <input type="hidden" id="approvequantity" name="quantity" />
        <input type="hidden" id="approveorderId" name="orderId" />
        <input type="hidden" id="approverateId" name="rateId" />
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success">Approve</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Are You Sure?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/admin/rejectReturn" method="post">
        <div class="modal-body">
          <p>Do you want to reject this return?</p>
        </div>
        <input type="hidden" id="rejectquantity" name="quantity" />
        <input type="hidden" id="rejectorderId" name="orderId" />
        <input type="hidden" id="rejectrateId" name="rateId" />
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-danger">Reject</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let debounceTimer;

  function searchInvoice(value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const currentPage = 1;
      window.location.href = `/admin/returndata?pagenumber=${currentPage}&invoice=${encodeURIComponent(value)}`;
    }, 700);
  }

  function loadPage(pageNumber) {
    const searchValue = document.getElementById('searchInput').value || '';
    window.location.href = `/admin/returndata?pagenumber=${pageNumber}&invoice=${encodeURIComponent(searchValue)}`;
  }

  function approve(orderId, rateId, quantity) {
    document.getElementById('approveorderId').value = orderId;
    document.getElementById('approverateId').value = rateId;
    document.getElementById('approvequantity').value = quantity;
  }

  function reject(orderId, rateId, quantity) {
    document.getElementById('rejectorderId').value = orderId;
    document.getElementById('rejectrateId').value = rateId;
    document.getElementById('rejectquantity').value = quantity;
  }
</script>

<% if (successmessage && successmessage.length > 0) { %>
<script>
  Swal.fire({
    text: "<%= successmessage %>",
    icon: "success"
  });
</script>
<% } %>
