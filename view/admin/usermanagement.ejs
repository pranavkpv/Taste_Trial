<%- include('partials/admin') %>

<div class="mt-5 w-75" style="margin-left:15%;">
  <div class="container-fluid px-4 py-4">

    <!-- Page Title -->
    <h3 class="my-3">User Management</h3>

    <!-- Search and Filter Row -->
    <div class="row mb-4">
      <!-- Search Input -->
      <div class="col-md-6 mb-2 mb-md-0">
        <div class="input-group">
          <span class="input-group-text bg-success text-light"><i class="fas fa-search"></i></span>
          <input type="text" id="searchInput" oninput="searchUser(this.value)" class="form-control"
            placeholder="Search by username..." value="<%= searcheduser || '' %>">
        </div>
      </div>
      <!-- Status Filter -->
      <div class="col-md-6">
        <select id="statusFilter" class="form-select w-50" onchange="filter()">
          <option value="" <%= !status || status === '' ? 'selected' : '' %>>Select</option>
          <option value="Blocked" <%= status === 'Blocked' ? 'selected' : '' %>>Blocked</option>
          <option value="Unblocked" <%= status === 'Unblocked' ? 'selected' : '' %>>Unblocked</option>
          <option value="All" <%= status === 'All' ? 'selected' : '' %>>All Users</option>
        </select>
      </div>
    </div>

    <!-- Users Table -->
    <div class="table-responsive">
      <table class="table table-hover text-center align-middle" id="userTable">
        <thead class="table-light">
          <tr>
            <th scope="col">Sl No</th>
            <th scope="col">Username</th>
            <th scope="col">Phone</th>
            <th scope="col">Email</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          <% if (userData && userData.length === 0) { %>
          <tr>
            <td colspan="5" class="text-center">No users found</td>
          </tr>
          <% } else { %>
          <% userData.forEach((element, index) => { %>
          <tr>
            <td class="tableindex"><%= startIndex + index %></td>
            <td class="tabledata"><%= element.firstname %> <%= element.lastname %></td>
            <td class="tablephone"><%= element.phonenumber %></td>
            <td class="tableemail"><%= element.email %></td>
            <td>
              <% if (element.is_blocked) { %>
              <a href="#" class="text-success" data-bs-toggle="modal" data-bs-target="#unblockUserModal"
                onclick="unblockfun('<%= element._id %>')" title="Unblock"><i class="fa-solid fa-unlock"></i></a>
              <% } else { %>
              <a href="#" class="text-success" data-bs-toggle="modal" data-bs-target="#blockUserModal"
                onclick="blockfun('<%= element._id %>')" title="Block"><i class="fa-solid fa-lock"></i></a>
              <% } %>
            </td>
          </tr>
          <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="d-flex justify-content-center mt-3">
      <ul class="pagination pagination-sm">
        <% for (let i = 1; i <= page; i++) { %>
        <li class="page-item  <%= i === selectedpage ? 'active' : '' %>">
          <button class="page-link <%= i === selectedpage ? 'bg-success' : '' %>" onclick="loadPage('<%= i %>')"><%= i %></button>
        </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>

<!-- Block User Modal -->
<div class="modal fade" id="blockUserModal" tabindex="-1" aria-labelledby="blockUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="/admin/blockuser" method="post">
        <input type="hidden" id="hideid" name="hideid" />
        <div class="modal-body">
          <p>Do you want to block the user?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Unblock User Modal -->
<div class="modal fade" id="unblockUserModal" tabindex="-1" aria-labelledby="unblockUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="/admin/unblockuser" method="post">
        <input type="hidden" id="unhideid" name="unhideid" />
        <div class="modal-body">
          <p>Do you want to unblock the user?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-success">Yes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<%- include('partials/footer') %>
<script>
  // Live search with debounce
  let debounceTimer;
  function searchUser(value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const status = document.getElementById("statusFilter").value;
      const page = 1;
      window.location.href = `/admin/usermanagement?pagenumber=${ page }&user=${ encodeURIComponent(value) }&status=${ status }`;
    }, 700);
  }

  function filter() {
    const searchValue = document.getElementById('searchInput').value || '';
    const status = document.getElementById("statusFilter").value;
    window.location.href = `/admin/usermanagement?pagenumber=1&user=${ encodeURIComponent(searchValue) }&status=${ status }`;
  }

  function loadPage(pageNumber) {
    const searchValue = document.getElementById('searchInput').value || '';
    const status = document.getElementById("statusFilter").value;
    window.location.href = `/admin/usermanagement?pagenumber=${ pageNumber }&user=${ encodeURIComponent(searchValue) }&status=${ status }`;
  }

  function blockfun(id) { document.getElementById('hideid').value = id; }
  function unblockfun(id) { document.getElementById('unhideid').value = id; }
</script>