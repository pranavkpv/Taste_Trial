<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<%- include('partials/userheader') %>

<nav aria-label="breadcrumb" class="mt-5">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/user/home">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">Shop Page</li>
  </ol>
</nav>

<div class="container-fluid mt-5 mb-5">
  <div class="row g-4">
    <% rates.forEach(element => { %>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100 shadow-sm product-card position-relative">
          <div class="position-absolute top-0 start-0 m-2">
            <span class="badge <%= element.foodDetails[0]?.is_veg === 'veg' ? 'bg-success' : 'bg-danger' %> fs-6">
              <%= element.foodDetails[0]?.is_veg === 'veg' ? 'Veg' : 'Non-Veg' %>
            </span>
          </div>

          <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-2 wishlist-btn"
            data-rate-id="<%= element._id %>"
            data-user-id="<%= userId %>"
            data-is-in-wishlist="<%= element.isInWishlist %>">
            <i class="<%= element.isInWishlist ? 'fas' : 'far' %> fa-heart text-danger fs-5"></i>
          </button>

          <img src="<%= element.images[0] %>" alt="Food Item" class="card-img-top img-fluid" style="object-fit: cover; height: 180px;">

          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1 text-truncate" title="<%= element.foodDetails[0]?.foodname %>">
              <%= element.foodDetails[0]?.foodname || 'Unknown Food' %>
              <small class="text-muted">(<%= element.varientDetails[0]?.varientname || '' %>)</small>
            </h5>

            <p class="card-subtitle mb-1 text-primary fw-semibold text-truncate" title="<%= element.hotelDetails[0]?.hotelname %>">
              <i class="fas fa-hotel me-1"></i> <%= element.hotelDetails[0]?.hotelname || 'Unknown Hotel' %>
            </p>

            <p class="mb-2 text-muted small">
              <i class="far fa-clock me-1"></i><%= element.foodDetails[0]?.duration_time %> mins
            </p>

            <% 
              const catOffer = element.CategoryDetails[0]?.offer || 0;
              const foodOffer = element.foodDetails[0]?.offer || 0;
              const bestOffer = catOffer >= foodOffer ? catOffer : foodOffer;
            %>
            <% if (bestOffer > 0) { %>
              <span class="badge bg-success mb-2 align-self-start px-3 py-1 fs-6">
                <%= bestOffer %>% Offer
              </span>
            <% } %>

            <div class="mt-auto d-flex justify-content-between align-items-center">
              <h6 class="text-danger mb-0">â‚¹ <%= element.rate %></h6>
              <button class="btn btn-primary btn-sm addTocart"
                data-rate-id="<%= element._id %>"
                data-hotel-id="<%= element.hotelDetails[0]?._id %>"
                data-food-id="<%= element.foodDetails[0]?._id %>"
                data-varient-id="<%= element.varientDetails[0]?._id %>">
                <i class="fas fa-shopping-cart me-1"></i> Add to Cart
              </button>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<%- include('partials/userfooter') %>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // Wishlist toggle
  document.querySelectorAll('.wishlist-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
      e.preventDefault();
      const rateid = button.dataset.rateId;
      const userid = button.dataset.userId;
      const isInWishlist = button.dataset.isInWishlist === 'true';
      const icon = button.querySelector('i');

      try {
        const url = isInWishlist ? '/user/removeWishData' : '/user/addToWishlist';
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rateid, userid })
        });
        const result = await response.json();

        if (result.error) {
          Swal.fire({ title: result.error, icon: 'error' }).then(() => location.href = "/user/logout");
          return;
        }

        // Toggle UI
        button.dataset.isInWishlist = (!isInWishlist).toString();
        icon.className = !isInWishlist ? 'fas fa-heart text-danger' : 'far fa-heart text-danger';

        Swal.fire({
          title: !isInWishlist ? 'Added to Wishlist!' : 'Removed from Wishlist!',
          icon: 'success',
          toast: true,
          position: 'top-end',
          timer: 1500,
          showConfirmButton: false
        });
      } catch (err) {
        Swal.fire({ title: 'Error', text: 'Something went wrong!', icon: 'error' });
      }
    });
  });

  // Add to cart
  document.querySelectorAll('.addTocart').forEach(button => {
    button.addEventListener('click', async (e) => {
      e.preventDefault();
      const rateId = button.dataset.rateId;
      const hotelid = button.dataset.hotelId;
      const foodid = button.dataset.foodId;
      const varientid = button.dataset.varientId;

      try {
        const response = await fetch('/user/AddToCart', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rateId, hotelid, foodid, varientid, numberofstock: 1 })
        });
        const data = await response.json();

        if (data.error) {
          Swal.fire({ title: 'Error', text: data.error, icon: 'error' }).then(() => location.href = '/user/logout');
        } else if (data.exist) {
          Swal.fire({ title: 'Info', text: data.exist, icon: 'info' });
        } else if (data.stock) {
          Swal.fire({ title: 'Limit', text: data.stock, icon: 'info' });
        } else if (data.success) {
          Swal.fire({ title: 'Success', text: data.success, icon: 'success' });
        }
      } catch (error) {
        Swal.fire({ title: 'Error', text: 'Something went wrong!', icon: 'error' });
      }
    });
  });

});
</script>
