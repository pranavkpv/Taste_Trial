<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="/dashboard.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
   .rateDetails p{
      line-height: 10px;
   }
</style>
<%- include('partials/profileheadr') %>
<div class="container mt-5">
   <h2 class="text-center mb-4">Order Details </h2>

   <!-- Address Selection -->
   <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
         <h5>Select Delivery Address</h5>
      </div>
      <div class="card-body">
         <form> 
            <% addressess.forEach((element, index) => { %>
               <div class="form-check">
                  <input type="hidden" value="<%= element._id %>" id="addressId<%= index %>">
                  <input class="form-check-input" type="radio" name="address" id="address<%= index %>" <%= index === 0 ? 'checked' : '' %>>
                  <label class="form-check-label" for="address<%= index %>">
                     <b><%= element.addresstype.toUpperCase() %> Address</b>, <%= element.landmark %>, <%= element.city %>, 
                     <%= element.state %>, PIN :<%= element.pin_code %>, MOB:<%= element.mobile_no %>, 
                     <span><%= element.alternative_no %></span>
                  </label>
               </div>
            <% }) %>
            
            
         </form>
      </div>
   </div>

   <!-- Order Summary Table -->
   <div class="card shadow-sm mb-5">
      <div class="card-header bg-primary text-white">
        <h5>Order Summary</h5>
      </div>
      <div class="card-body">
         <% datas.forEach(element => { %>
            <div class="d-flex mb-3 " style="gap:200px">
               <div class="me-3">
                 <img src="<%= element.rateDetails.images[0] %>" alt="Product" class="img-fluid rounded" style="width: 180px; height: 220px;">
               </div>
               <div>
                 <h6 class="fw-bold fs-5"><%= element.foodDetails[0].foodname %></h6>
                 <p class="mb-1"><strong>Hotel Name : </strong><%= element.hotelDetails[0].hotelname %></p>
                 <p class="mb-1"><strong>Variant : </strong><%= element.varientDetails[0].varientname %></p>
                 <p class="mb-1"><strong>Quantity : </strong><%= element.number %></p>
               </div>
               <div class="rateDetails">
                 <h3 class="text-success">Rate Details</h3>
                 <p><strong>Base Rate : </strong><%= element.number*element.rateDetails.rate %></p>
                 <p><strong>Gst Amount : </strong><%= element.number*(element.rateDetails.rate*element.rateDetails.gst_per/100) %></p>
                 <p><strong>Packing Charge : </strong><%= element.number*(element.rateDetails.rate*element.rateDetails.packing_per/100) %></p>
                 <p><strong>Delivery Charge : </strong><%= element.number*(element.rateDetails.rate*element.rateDetails.delivery_per/100) %></p>
                 <p class="fs-5">Final Amount    :<%= element.number*(element.rateDetails.rate+element.rateDetails.rate*element.rateDetails.gst_per/100+
                 element.rateDetails.rate*element.rateDetails.packing_per/100+element.rateDetails.rate*element.rateDetails.delivery_per/100) %></p>
               </div>
             </div>    
           <hr>         
         <% }) %>
      </div>
    </div>
    <% 
let totalSum = 0; // Initialize the total sum
datas.forEach(element => { 
  // Calculate the final amount for the current element
  const finalAmount = element.number * (
    element.rateDetails.rate +
    element.rateDetails.rate * element.rateDetails.gst_per / 100 +
    element.rateDetails.rate * element.rateDetails.packing_per / 100 +
    element.rateDetails.rate * element.rateDetails.delivery_per / 100
  );

  totalSum += finalAmount; // Add the final amount to the total sum
})
%>
<h3 class="text-danger" style="text-align: right;">Net Amount : â‚¹  <%= totalSum %></h3>

    

   <!-- Payment Methods -->
 
   <div class="card shadow-sm mb-5">
      <div class="card-header bg-primary text-white">
         <h5>Choose Payment Method</h5>
      </div>
      <div class="card-body">
         <form action="/user/orderSuccess" method="POST">
            <input type="hidden" id="addressId" name="addressId">
            <% datas.forEach(element => { %>
               <input type="hidden" value="<%= element._id %>" name="cartId">
               <input type="hidden" value="<%= element.number %>" name="numberofproduct">
            <% }) %>
            <input type="hidden" id="userid" value="<%= userid %>" name="userid">
            <!-- Hidden field to store the selected payment method -->
            <input type="hidden" id="selectedPaymentMethod" name="selectedPaymentMethod" value="COD">
         
            <div class="form-check">
               <input class="form-check-input" type="radio" name="paymentMethod" value="COD" id="cod" checked>
               <label class="form-check-label" for="cod">Cash on Delivery</label>
            </div>
            <div class="form-check">
               <input class="form-check-input" type="radio" name="paymentMethod" value="UPI" id="upi">
               <label class="form-check-label" for="upi">UPI</label>
               <div class="mt-2" id="upiInput" style="display: none;">
                  <input type="text" class="form-control" name="upiId" placeholder="Enter your UPI ID">
               </div>
            </div>
            <div class="form-check">
               <input class="form-check-input" type="radio" name="paymentMethod" value="Other" id="other">
               <label class="form-check-label" for="other">Other Payment Options</label>
            </div>
            <div class="mt-4 text-center">
               <button type="submit" class="btn btn-success">Confirm Order</button>
            </div>
         </form>
         
      </div>
   </div>
</div>

<%- include('partials/userfooter') %>
<script>
   // Toggle UPI ID input field
   document.getElementById('upi').addEventListener('change', function () {
      document.getElementById('upiInput').style.display = 'block';
   });

   document.getElementById('cod').addEventListener('change', function () {
      document.getElementById('upiInput').style.display = 'none';
   });

   document.getElementById('other').addEventListener('change', function () {
      document.getElementById('upiInput').style.display = 'none';
   });
   
// Function to update the addressId field based on the selected radio button
function updateAddressId() {
   const selectedRadio = document.querySelector('input[name="address"]:checked'); // Get the selected radio button
   if (!selectedRadio) return; // Exit if no radio button is selected

   const addressIndex = selectedRadio.id.replace('address', ''); // Extract the index from the radio button's id
   const addressValue = document.getElementById(`addressId${addressIndex}`).value; // Get the corresponding address value
   const addressIdField = document.getElementById('addressId'); // Get the hidden input field for address ID
   addressIdField.value = addressValue; // Update the hidden input field with the address ID
}

// Add an event listener to update the address ID whenever a radio button is selected
document.querySelectorAll('input[name="address"]').forEach(radio => {
   radio.addEventListener('change', updateAddressId);
});

// Set the initial value of the addressId field on page load
document.addEventListener('DOMContentLoaded', updateAddressId);

 // Get all radio buttons for payment methods
 const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
   const selectedPaymentMethodField = document.getElementById('selectedPaymentMethod');
   const upiInputField = document.getElementById('upiInput');

   // Add event listeners to update the hidden input field
   paymentMethods.forEach(paymentMethod => {
      paymentMethod.addEventListener('change', () => {
         selectedPaymentMethodField.value = paymentMethod.value;

         // Show or hide UPI input field based on the selected payment method
         if (paymentMethod.value === 'UPI') {
            upiInputField.style.display = 'block';
         } else {
            upiInputField.style.display = 'none';
         }
      });
   });



</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<% if (successmessage && successmessage.length>0) { %>
   <script>
     Swal.fire({
       text: "<%= successmessage %>",
       icon: "success"
     });
   </script>
 <% } %>
